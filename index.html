<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Cenjud Play — Desafio Interativo</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f5f7fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#6b7280;
      --primary:#003B8E;
      --accent:#00B3FF;
      --glass: rgba(255,255,255,0.7);
      --success:#16a34a;
      --danger:#ef4444;
      --radius:14px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Roboto,Arial;background:linear-gradient(180deg,var(--primary)10%,#0f3b7a50 40%,var(--bg)100%);color:var(--text)}
    .container{max-width:1100px;margin:28px auto;padding:18px}
    .hero{display:flex;gap:18px;align-items:center;justify-content:space-between;background:linear-gradient(135deg,rgba(255,255,255,0.06), rgba(255,255,255,0.02));border-radius:20px;padding:28px;box-shadow:0 10px 30px rgba(2,6,23,0.12);backdrop-filter: blur(6px);}
    .brand{color:#fff}
    .brand h1{margin:0;font-weight:800;font-size:22px;letter-spacing:-0.5px}
    .brand p{margin:4px 0 0;color:#e6f0ff}
    .roles{display:flex;gap:12px}
    .role-btn{background:linear-gradient(90deg,#fff,#f8fbff);border-radius:12px;padding:12px 18px;border:0;cursor:pointer;min-width:180px;display:flex;gap:12px;align-items:center;box-shadow:0 6px 18px rgba(3,16,70,0.14);transition:transform .18s, box-shadow .18s}
    .role-btn .icon{width:36px;height:36px;border-radius:10px;background:linear-gradient(180deg,var(--accent),#3fd0ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}
    .role-btn:hover{transform:translateY(-6px);box-shadow:0 18px 30px rgba(3,16,70,0.18)}
    .stage{display:grid;grid-template-columns:1fr 380px;gap:18px;margin-top:18px}
    .card{background:var(--card);border-radius:var(--radius);padding:18px;box-shadow:0 8px 24px rgba(2,6,23,0.08)}
    .input{display:block;width:100%;padding:10px;border-radius:10px;border:1px solid #e8eef9}
    #playerName,#playerRoom,#roomName{max-width:280px;}
    .small{font-size:13px;color:var(--muted)}
    #createRoomBtn, #importBtn {
      width: 48%;
      height: 46px;
      font-weight: 700;
      border-radius: 10px;
      font-size: 15px;
      transition: all .2s ease;
    }
    #createRoomBtn { background: linear-gradient(90deg,var(--primary),var(--accent)); color:#fff; border:0; box-shadow:0 8px 18px rgba(0,59,142,0.12); }
    #importBtn { background: linear-gradient(90deg,#fff,#f8fbff); border:1px solid #e5ecfa; color:var(--primary); }
    #createRoomBtn:hover, #importBtn:hover { transform: translateY(-3px); box-shadow:0 8px 22px rgba(3,16,70,0.12); }

    .btn-primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:#fff;border-radius:10px;padding:10px 12px;border:0;cursor:pointer;font-weight:700;box-shadow:0 8px 18px rgba(0,59,142,0.12)}
    .btn-ghost{background:transparent;border:1px solid #eef4ff;border-radius:10px;padding:10px 12px;cursor:pointer}
    .host-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px}
    .status-pill{padding:8px;border-radius:10px;background:#f3f8ff;color:var(--primary);font-weight:700}
    .leaderboard-title{display:flex;justify-content:space-between;align-items:center}
    .leaderboard-list{margin-top:12px}
    .lead-item{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);margin-bottom:8px;border:1px solid #eef4ff;transition:transform .2s}
    .lead-item.top{background:linear-gradient(90deg,#fff8e8,#fff)}
    .medal{width:44px;height:44px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:800}
    .medal.gold{background:linear-gradient(180deg,#ffd966,#ffc400);color:#6b4800}
    .medal.silver{background:linear-gradient(180deg,#e6e6e6,#d5d5d5);color:#444}
    .medal.bronze{background:linear-gradient(180deg,#f7d7c2,#f3b58b);color:#6b3b10}
    .game-hero{display:flex;justify-content:space-between;align-items:center;gap:12px}
    .question {
      font-weight:600;
      font-size:18px;
      line-height:1.5;
      margin-bottom:18px;
      padding:14px 10px;
      border-radius:10px;
      background:linear-gradient(180deg,#fff,#f8fafc);
      box-shadow:0 4px 10px rgba(2,6,23,0.05);
    }
    .progress{height:10px;background:#eef5ff;border-radius:999px;overflow:hidden;margin-top:10px}
    .progress > span{display:block;height:100%;width:100%;background:linear-gradient(90deg,var(--accent),#59e0ff);transform-origin:left;transition:width 0.3s linear}
    .options{display:grid;grid-template-columns:1fr 1fr;gap:16px 14px;margin-top:16px}
    .option-btn{padding:18px;border-radius:12px;border:1px solid #eef4ff;background:linear-gradient(180deg,#fff,#f7fbff);font-weight:600;font-size:16px;cursor:pointer;transition:transform .12s,box-shadow .12s}
    .option-btn:hover{transform:translateY(-4px);box-shadow:0 10px 20px rgba(3,16,70,0.06)}
    .option-btn.correct{background:linear-gradient(90deg,#e7f8ee,#c8f0d3);border-color:#c8f0d3;transform:scale(1.02)}
    .option-btn.wrong{background:linear-gradient(90deg,#fff3f3,#ffe0e0);border-color:#ffe0e0;transform:scale(.98)}
    .feedback{margin-top:12px;padding:10px;border-radius:10px;font-weight:800;text-align:center}
    .feedback.good{background:#ecfdf5;color:var(--success);border-left:4px solid var(--success)}
    .feedback.bad{background:#fff0f0;color:var(--danger);border-left:4px solid var(--danger)}
    .hidden{display:none}
    #youName { font-weight:900; font-size:20px; color:var(--accent); text-align:center; margin-top:6px; letter-spacing:0.3px; }
    .final-overlay{position:fixed;inset:0;background:rgba(2,6,23,0.55);display:flex;align-items:center;justify-content:center;z-index:9999}
    .final-card{width:min(760px,95%);padding:22px;border-radius:16px;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 20px 60px rgba(2,6,23,0.32)}
    .final-medal{font-size:28px;margin-right:12px}
    .final-top{display:flex;gap:14px;align-items:center;justify-content:center;margin-bottom:12px}
    .final-list{margin-top:8px}
    .final-list { max-height: 360px; overflow-y: auto; padding-right: 10px; }
    .sound-toggle{position:fixed;right:18px;top:18px;z-index:99999;background:linear-gradient(90deg,#fff,#f7fbff);border-radius:12px;padding:10px;border:1px solid #eef4ff;box-shadow:0 8px 26px rgba(2,6,23,0.12);display:flex;gap:8px;align-items:center}
    .sound-toggle button{background:transparent;border:0;cursor:pointer;font-size:18px}
    .volume-control{width:140px}
    .toast-music{position:fixed;right:18px;bottom:18px;background:linear-gradient(90deg,#0b74ff,#00b3ff);color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;box-shadow:0 8px 26px rgba(2,6,23,0.18);display:none;z-index:100000}
    .password-modal{position:fixed;inset:0;background:rgba(2,6,23,0.45);display:flex;align-items:center;justify-content:center;z-index:100001}
    .password-card{width:380px;padding:18px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);box-shadow:0 12px 40px rgba(2,6,23,0.28)}
    /* Ajuste de largura do campo da senha */
    #organizerPassword {
      width: 70% !important;
      margin: 0 auto;
      display: block;
    }
    @media(max-width:980px){.stage{grid-template-columns:1fr;} .hero{flex-direction:column;align-items:flex-start;gap:12px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="hero">
      <div class="brand"><h1>Cenjud Play</h1><p>Desafio interativo</p></div>
      <div class="roles">
        <button id="cardOrganizer" class="role-btn"><div class="icon">O</div><div><div style="font-weight:800">Organizador</div><div class="small">Crie sala e conduza</div></div></button>
        <button id="cardPlayer" class="role-btn"><div class="icon">J</div><div><div style="font-weight:800">Jogador</div><div class="small">Participe e responda</div></div></button>
      </div>
    </div>

    <div class="stage" id="stage" style="display:none">
      <div class="card" id="leftCard"></div>
      <div class="card" id="rightCard">
        <div class="leaderboard-title"><div style="font-weight:800">Ranking — Tempo real</div><div class="small" id="playerCount">0 jogadores</div></div>
        <div class="leaderboard-list" id="organizerLeaderboard"><div class="small">Nenhum jogador ainda</div></div>
      </div>
    </div>

    <!-- Password modal for organizer -->
    <div id="passwordModal" class="password-modal" style="display:none">
      <div class="password-card">
        <h3 style="margin:0 0 8px 0">Acesso Organizador</h3>
        <p class="small" style="margin:0 0 12px 0">Insira a senha para acessar o painel do organizador.</p>
        <input id="organizerPassword" type="password" class="input" placeholder="Senha">
        <div style="display:flex;gap:8px;margin-top:12px;justify-content:flex-end">
          <button id="cancelPassword" class="btn-ghost">Cancelar</button>
          <button id="okPassword" class="btn-primary">Entrar</button>
      
    </div>

    <!-- Templates -->
    <template id="organizerTemplate">
      <div>
        <h2 style="margin:0 0 8px 0">Painel do Organizador</h2>
        <label class="small" style="margin-top:8px;display:block">Nome da sala</label>
        <input id="roomName" class="input" placeholder="Ex: TREINAMENTO_A">
        <div style="margin-top:10px"><button id="createRoomBtn" class="btn-primary">Criar Sala</button></div>
        <div class="action-row" style="margin-top:12px">
          <input id="fileInput" type="file" accept=".xlsx,.xls,.csv" class="hidden">
          <button id="importBtn" class="btn-ghost">Importar Quiz</button>
        </div>
        <label class="small" style="margin-top:12px;display:block;">🎧 Trilha sonora</label>
        <select id="musicSelect" class="input" style="margin-top:6px">
          <option value="">Nenhuma</option><option value="energia">Energia</option><option value="blues">Blues</option><option value="funk">Funk</option><option value="estilo">Estilo</option><option value="corporativo">Corporativo</option><option value="pop">Pop</option><option value="horizonte">Horizonte</option>
        </select>
        <div id="quizControls" style="margin-top:16px;display:none">
          <div class="host-grid"><div class="status-pill" id="statusLabel">Aguardando</div><div style="text-align:right"><button id="unlockAudioBtn" class="btn-ghost" title="Tentar liberar áudio">Liberar áudio</button></div></div>

          <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="startBtn" class="btn-primary">Iniciar</button>
            <button id="prevBtn" class="btn-ghost">Anterior</button>
            <button id="nextBtn" class="btn-primary">Próxima</button>
            <button id="endBtn" class="btn-ghost">Encerrar</button>
          </div>

          <!-- Organizer view: only active question + timer -->
          <div style="margin-top:16px">
            <div class="small" style="margin-bottom:8px">Visualização Atual</div>
            <div id="orgCurrent" style="padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #eef4ff">
              <div id="orgQIndex" class="small">Pergunta —</div>
              <div id="orgQuestionText" class="question">Aguardando...</div>
              <div class="progress"><span id="orgProgressBar" style="width:100%"></span></div>
              <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
                <div id="orgTimer" class="small status-pill">Tempo: --s</div>
                <div class="small" id="orgStatusSmall">—</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </template>

    <template id="playerTemplate">
      <div>
        <h2 style="margin:0 0 8px 0">Entrar como Jogador</h2>
        <label class="small">Seu nome</label>
        <input id="playerName" class="input" placeholder="Ex: Maria">
        <label class="small" style="margin-top:8px;display:block">Sala</label>
        <input id="playerRoom" class="input" placeholder="Ex: TREINAMENTO_A">
        <div style="margin-top:10px"><button id="joinRoomBtn" class="btn-primary">Entrar</button></div>
      </div>
    </template>

    <template id="gameTemplate">
      <div>
        <div class="game-hero">
          <div>
            <div class="small" id="qIndex">Pergunta —</div>
            <div id="youName">—</div>
          </div>
          <div style="text-align:center"><div id="timer" class="small status-pill">Tempo: --s</div></div>
        </div>
        <div style="margin-top:12px">
          <div id="questionText" class="question">Aguardando início...</div>
          <div class="progress" aria-hidden="true"><span id="progressBar" style="width:100%"></span></div>
          <div class="options" id="optionsArea"></div>
          <div id="feedbackArea" class="feedback hidden"></div>
        </div>
      </div>
    </template>

  </div>

  <div id="musicToast" class="toast-music">🎵 Trilha ativada</div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-database-compat.js"></script>
  <!-- SheetJS for Excel/CSV import -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBJmHP0hkqc9ry36UWDuns614ebWWO8xe0",
      authDomain: "quiz-treinamento-2025.firebaseapp.com",
      databaseURL: "https://quiz-treinamento-2025-default-rtdb.firebaseio.com",
      projectId: "quiz-treinamento-2025"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Tracks and effects
    const TRACKS = {
      energia: "https://raw.githubusercontent.com/dirproccenjud/play/main/energy-pop-152391.mp3",
      blues: "https://raw.githubusercontent.com/dirproccenjud/play/main/majestic-blues-351409.mp3",
      funk: "https://raw.githubusercontent.com/dirproccenjud/play/main/fun-funk-music-349237.mp3",
      estilo: "https://raw.githubusercontent.com/dirproccenjud/play/main/fashion-upbeat-dance-designer-416395.mp3",
      corporativo: "https://raw.githubusercontent.com/dirproccenjud/play/main/ambient-corporate-inspiring-money-403965.mp3",
      pop: "https://raw.githubusercontent.com/dirproccenjud/play/main/upbeat-pop-fun-happy-commercial-music-401980.mp3",
      horizonte: "https://raw.githubusercontent.com/dirproccenjud/play/main/beyond-the-horizon-cinematic-background-music-for-video-short-2-413333.mp3"
    };
    const EFFECTS = { correct: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_35c388b8e7.mp3", wrong: "https://cdn.pixabay.com/download/audio/2022/03/15/audio_5a2b1cf52b.mp3" };

    // helpers
    const $ = id => document.getElementById(id);
    const create = (s) => document.createElement(s);

    // sample questions fallback
    const OFFICIAL_QUESTIONS = [
      {"q":"Exemplo: pergunta?","options":["a","b"],"answer":0,"time":20}
    ];

    const POSITIVE=["🎉 Muito bem!","👏 Você mandou bem!","🔥 Excelente!"];
    const NEGATIVE=["😅 Não foi dessa vez!","🙃 Quase!","💡 Tente de novo!"];

    // state
    const state = { role:null, name:null, room:null, uid:null };
    let localTimer = null;
    const scheduled = {};

    // audio players
    const sharedAudio = new Audio(); sharedAudio.loop = true; sharedAudio.volume = 0.7; sharedAudio.crossOrigin = 'anonymous';
    const effectCorrect = new Audio(EFFECTS.correct); const effectWrong = new Audio(EFFECTS.wrong); effectCorrect.volume = 0.7; effectWrong.volume = 0.7; effectCorrect.crossOrigin = 'anonymous'; effectWrong.crossOrigin = 'anonymous';

    // WebAudio context for unlocking / better compatibility with autoplay policies
    let audioCtx = null;
    let sharedSource = null;
    let effectsSourceCorrect = null;
    let effectsSourceWrong = null;

    function tryUnlockAudio() {
      try {
        if(!audioCtx) {
          audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          try {
            sharedSource = audioCtx.createMediaElementSource(sharedAudio);
            sharedSource.connect(audioCtx.destination);
            effectsSourceCorrect = audioCtx.createMediaElementSource(effectCorrect);
            effectsSourceCorrect.connect(audioCtx.destination);
            effectsSourceWrong = audioCtx.createMediaElementSource(effectWrong);
            effectsSourceWrong.connect(audioCtx.destination);
          } catch(e) {
            console.warn('MediaElementSource may already exist or not available:', e);
          }
        }
        if(audioCtx.state === 'suspended') {
          audioCtx.resume().then(()=> { showMusicToast(); }).catch(()=>{});
        }
      } catch(e) {
        console.warn('Erro ao tentar desbloquear áudio:', e);
      }
    }

    // persisted settings
    const LS_MUTE = 'cj_sound_muted'; const LS_VOL  = 'cj_sound_volume';
    let isMuted = localStorage.getItem(LS_MUTE) === 'true';
    let localVolume = Number(localStorage.getItem(LS_VOL) || 0.7);
    sharedAudio.volume = localVolume; effectCorrect.volume = localVolume; effectWrong.volume = localVolume;

    // base elements
    const cardOrganizer = $('cardOrganizer'); const cardPlayer = $('cardPlayer'); const stage = $('stage'); const leftCard = $('leftCard'); const organizerLeaderboard = $('organizerLeaderboard'); const musicToast = $('musicToast');

    // sound UI
    const soundDiv = document.createElement('div'); soundDiv.className='sound-toggle'; soundDiv.style.display='none';
    soundDiv.innerHTML = `<button id="soundToggleBtn" title="Ativar / Desativar som">` + (isMuted ? '🔇' : '🔊') + `</button><input id="volumeRange" class="volume-control" type="range" min="0" max="1" step="0.05" value="${localVolume}">`;
    document.body.appendChild(soundDiv);
    const soundToggleBtn = soundDiv.querySelector('#soundToggleBtn'); const volumeRange = soundDiv.querySelector('#volumeRange');
    function updateSoundUI(){ soundToggleBtn.textContent = isMuted ? '🔇' : '🔊'; volumeRange.value = localVolume; sharedAudio.muted = !!isMuted; effectCorrect.muted = !!isMuted; effectWrong.muted = !!isMuted; }
    updateSoundUI();
    soundToggleBtn.addEventListener('click', ()=>{ isMuted = !isMuted; localStorage.setItem(LS_MUTE, isMuted ? 'true' : 'false'); updateSoundUI(); });
    volumeRange.addEventListener('input',(e)=>{ localVolume = Number(e.target.value); sharedAudio.volume = localVolume; effectCorrect.volume = localVolume; effectWrong.volume = localVolume; localStorage.setItem(LS_VOL, String(localVolume)); });

    // password modal elements
    const passwordModal = $('passwordModal'); const organizerPassword = $('organizerPassword'); const okPassword = $('okPassword'); const cancelPassword = $('cancelPassword');

    // wire role buttons (organizer requires password)
    cardOrganizer.addEventListener('click', ()=> {
      tryUnlockAudio(); // unlock audio on gesture
      organizerPassword.value = '';
      passwordModal.style.display = 'flex';
      organizerPassword.focus();
    });
    cancelPassword.addEventListener('click', ()=> { passwordModal.style.display='none'; });
    okPassword.addEventListener('click', ()=> {
      const val = organizerPassword.value.trim();
      if(val === '2024') {
        passwordModal.style.display='none';
        openOrganizer();
      } else {
        alert('Senha incorreta.');
      }
    });
    organizerPassword.addEventListener('keydown', (e)=> { if(e.key === 'Enter'){ okPassword.click(); }});

    cardPlayer.addEventListener('click', ()=> {
      tryUnlockAudio(); // unlock audio for player as well
      openPlayer();
    });

    function openOrganizer(){ stage.style.display='grid'; leftCard.innerHTML=''; const tpl = document.getElementById('organizerTemplate').content.cloneNode(true); leftCard.appendChild(tpl); bindOrganizer(); soundDiv.style.display='flex'; }
    function openPlayer(){ stage.style.display='grid'; leftCard.innerHTML=''; const tpl = document.getElementById('playerTemplate').content.cloneNode(true); leftCard.appendChild(tpl); bindPlayer(); }
    function openGameUI(){ leftCard.innerHTML=''; const tpl = document.getElementById('gameTemplate').content.cloneNode(true); leftCard.appendChild(tpl); if($('youName') && state.name) $('youName').innerText = state.name; soundDiv.style.display='flex'; updateSoundUI(); }

    // Organizer
    function bindOrganizer(){
      const createBtn = leftCard.querySelector('#createRoomBtn');
      const importBtn = leftCard.querySelector('#importBtn');
      const fileInput = leftCard.querySelector('#fileInput');
      const musicSelect = leftCard.querySelector('#musicSelect');
      const startBtn = leftCard.querySelector('#startBtn');
      const prevBtn = leftCard.querySelector('#prevBtn');
      const nextBtn = leftCard.querySelector('#nextBtn');
      const endBtn = leftCard.querySelector('#endBtn');
      const statusLabel = leftCard.querySelector('#statusLabel');
      const orgQuestionText = leftCard.querySelector('#orgQuestionText');
      const orgQIndex = leftCard.querySelector('#orgQIndex');
      const orgTimer = leftCard.querySelector('#orgTimer');
      const orgProgressBar = leftCard.querySelector('#orgProgressBar');
      const orgStatusSmall = leftCard.querySelector('#orgStatusSmall');
      const unlockAudioBtn = leftCard.querySelector('#unlockAudioBtn');

      const roomInput = leftCard.querySelector('#roomName'); roomInput.style.maxWidth = '280px'; roomInput.style.display='block';

      unlockAudioBtn.addEventListener('click', ()=> {
        tryUnlockAudio();
        sharedAudio.volume = localVolume;
        sharedAudio.muted = isMuted;
        sharedAudio.play().then(()=> { showMusicToast(); }).catch(err=>{
          console.warn('play sharedAudio error', err);
          alert('Não foi possível reproduzir automaticamente. Se estiver em uma chamada (Teams/Zoom), ao compartilhar a tela ative "Incluir áudio do computador".');
        });
      });

      createBtn.addEventListener('click', async ()=>{
        const name = 'Organizador';
        const room = roomInput.value.trim().toUpperCase();
        if(!room) return alert('Preencha a sala.');
        state.role='organizer'; state.name=name; state.room=room; state.uid = genUid(name);

        const existsSnap = await db.ref(`rooms/${room}/meta`).get();
        if(existsSnap.exists()){
          const ok = confirm(`A sala "${room}" já existe. Deseja entrar na sala existente? (OK = sim)`);
          if(!ok) return;
        }

        await db.ref(`rooms/${room}/meta`).set({ host:name, createdAt: firebase.database.ServerValue.TIMESTAMP });
        leftCard.querySelector('#quizControls').style.display='block';
        statusLabel.innerText = `Sala ${room} criada/ativa`;
        attachRoom(room);
        alert('Sala pronta!');
        db.ref(`rooms/${state.room}/music`).get().then(snap => { const val = snap.val() || ''; if(musicSelect) musicSelect.value = val; });
      });

      importBtn.addEventListener('click', ()=> fileInput.click());
      fileInput.addEventListener('change', async (e)=>{
        const f = e.target.files[0]; if(!f) return;
        try{
          const arr = await f.arrayBuffer(); const wb = XLSX.read(arr,{type:'array'}); const ws = wb.Sheets[wb.SheetNames[0]]; const json = XLSX.utils.sheet_to_json(ws,{defval:''}); const parsed = parseQuestionsFromSheet(json);
          if(!parsed || !parsed.length) return alert('Nenhuma pergunta encontrada no arquivo.');
          if(!state.room) { const keep = confirm('Você ainda não criou uma sala. Deseja carregar perguntas no banco público temporário local? Recomendado criar sala primeiro.'); if(!keep) return; }
          await db.ref(`rooms/${state.room}/questions`).set(parsed);
          alert(`Importadas ${parsed.length} perguntas!`);
        }catch(err){ console.error(err); alert('Erro ao processar o arquivo. Verifique o formato.'); } finally { fileInput.value=''; }
      });

      musicSelect.addEventListener('change', (e)=>{ if(!state.room) return alert('Crie a sala primeiro antes de escolher a música.'); const val = e.target.value || ''; db.ref(`rooms/${state.room}/music`).set(val); showMusicToast(); });

      startBtn.addEventListener('click', async ()=>{
        if(state.role!=='organizer') return alert('Somente organizador');
        tryUnlockAudio();

        const qsSnap = await db.ref(`rooms/${state.room}/questions`).get(); const qs = qsSnap.val(); if(!qs || !qs.length) return alert('Carregue perguntas primeiro.');
        const first = qs[0]; const startAt = Date.now();
        await db.ref(`rooms/${state.room}/current`).set({ index:0, q:first.q, options:first.options, correct:first.answer, time:first.time||20, startAt });
        statusLabel.innerText = `Pergunta 1/${qs.length} ativa`;
        scheduleTally(state.room, 0, startAt, (first.time||20)*1000);
      });

      nextBtn.addEventListener('click', async ()=>{
        if(state.role!=='organizer') return;
        const curSnap = await db.ref(`rooms/${state.room}/current`).get(); const cur = curSnap.val(); if(!cur) return;
        const qsSnap = await db.ref(`rooms/${state.room}/questions`).get(); const qs = qsSnap.val() || [];
        const next = qs[cur.index+1]; if(!next) return alert('Fim do quiz');
        const startAt = Date.now();
        await db.ref(`rooms/${state.room}/current`).set({ index:cur.index+1, q:next.q, options:next.options, correct:next.answer, time:next.time||20, startAt });
        statusLabel.innerText = `Pergunta ${cur.index+2}/${qs.length} ativa`;
        scheduleTally(state.room, cur.index+1, startAt, (next.time||20)*1000);
      });

      prevBtn.addEventListener('click', async ()=>{
        if(state.role!=='organizer') return;
        const curSnap = await db.ref(`rooms/${state.room}/current`).get(); const cur = curSnap.val(); if(!cur) return;
        const prevIndex = Math.max(0, cur.index-1);
        const qsSnap = await db.ref(`rooms/${state.room}/questions`).get(); const qs = qsSnap.val() || [];
        const prev = qs[prevIndex]; if(!prev) return alert('Nenhuma anterior');
        const startAt = Date.now();
        await db.ref(`rooms/${state.room}/current`).set({ index:prevIndex, q:prev.q, options:prev.options, correct:prev.answer, time:prev.time||20, startAt });
        statusLabel.innerText = `Pergunta ${prevIndex+1}/${qs.length} ativa`;
        scheduleTally(state.room, prevIndex, startAt, (prev.time||20)*1000);
      });

      const endHandler = async ()=>{
        if(state.role!=='organizer') return;
        await db.ref(`rooms/${state.room}/current`).remove();
        await db.ref(`rooms/${state.room}/meta/final`).set(true);
      };
      endBtn.addEventListener('click', endHandler);
    }

    // Player
    function bindPlayer(){
      const joinBtn = leftCard.querySelector('#joinRoomBtn');
      joinBtn.addEventListener('click', async ()=>{
        const name = leftCard.querySelector('#playerName').value.trim();
        const room = leftCard.querySelector('#playerRoom').value.trim().toUpperCase();
        if(!name||!room) return alert('Preencha nome e sala.');
        state.role='player'; state.name=name; state.room=room; state.uid = genUid(name);
        const ref = db.ref(`rooms/${room}/players/${state.uid}`);
        await ref.set({ name, score:0, correctCount:0, answeredCount:0, avgTime:0, connectedAt: firebase.database.ServerValue.TIMESTAMP });
        ref.onDisconnect().remove();
        attachRoom(room);
        openGameUI();
        tryUnlockAudio();
      });
    }

    // attach listeners to room (keeps leaderboard live and shows final)
    function attachRoom(roomId){
      db.ref(`rooms/${roomId}/players`).on('value', snap=>{
        const players = snap.val() || {};
        $('playerCount').innerText = `${Object.keys(players).length} jogadores`;
        renderLeaderboard(players);
      });

      db.ref(`rooms/${roomId}/current`).on('value', snap=>{
        const cur = snap.val();
        if(!cur){
          if(state.role==='player'){
            if($('questionText')) $('questionText').innerText = 'Aguardando o Organizador iniciar o quiz...';
            if($('optionsArea')) $('optionsArea').innerHTML = '';
            if($('timer')) $('timer').innerText = 'Tempo: --s';
          }
          if(state.role==='organizer'){
            const orgQ = leftCard.querySelector('#orgQuestionText'); if(orgQ) orgQ.innerText = 'Aguardando...';
            const orgTimer = leftCard.querySelector('#orgTimer'); if(orgTimer) orgTimer.innerText = 'Tempo: --s';
            const orgPB = leftCard.querySelector('#orgProgressBar'); if(orgPB) orgPB.style.width = '100%';
            const orgIdx = leftCard.querySelector('#orgQIndex'); if(orgIdx) orgIdx.innerText = 'Pergunta —';
            const orgStatusSmall = leftCard.querySelector('#orgStatusSmall'); if(orgStatusSmall) orgStatusSmall.innerText = 'Sem pergunta ativa';
          }
          return;
        }
        if(state.role==='player'){
          if(!$('questionText')) openGameUI();
          showQuestion(cur);
        }
        if(state.role==='organizer'){
          const orgQ = leftCard.querySelector('#orgQuestionText');
          const orgIdx = leftCard.querySelector('#orgQIndex');
          const orgTimer = leftCard.querySelector('#orgTimer');
          const orgPB = leftCard.querySelector('#orgProgressBar');
          const orgStatusSmall = leftCard.querySelector('#orgStatusSmall');
          if(orgQ) orgQ.innerText = cur.q || '—';
          if(orgIdx) orgIdx.innerText = `Pergunta ${Number(cur.index)+1}`;
          if(orgStatusSmall) orgStatusSmall.innerText = `Tempo total: ${cur.time || 20}s`;
          if(window._orgLocalTimer) { clearInterval(window._orgLocalTimer); window._orgLocalTimer = null; }
          const total = Number(cur.time || 20);
          const startAt = Number(cur.startAt) || Date.now();
          function tickOrg(){
            const elapsed = Date.now() - startAt;
            const remS = Math.max(0, Math.ceil((startAt + total*1000 - Date.now())/1000));
            const pct = Math.max(0, Math.min(100, Math.round(((total*1000 - elapsed)/(total*1000))*100)));
            if(orgPB) orgPB.style.width = pct + '%';
            if(orgTimer) orgTimer.innerText = `Tempo: ${remS}s`;
            if(remS <= 0 && window._orgLocalTimer){ clearInterval(window._orgLocalTimer); window._orgLocalTimer = null; }
          }
          tickOrg(); window._orgLocalTimer = setInterval(tickOrg, 200);
        }
      });

      db.ref(`rooms/${roomId}/music`).on('value', snap=>{
        const key = snap.val() || '';
        if(!key){ try{ sharedAudio.pause(); sharedAudio.src=''; }catch(e){} return; }
        const url = TRACKS[key]; if(!url) return;
        if(sharedAudio.src !== url){ sharedAudio.src = url; sharedAudio.loop = true; }
        sharedAudio.volume = localVolume; sharedAudio.muted = isMuted;
        tryUnlockAudio();
        sharedAudio.play().then(()=>{ showMusicToast(); }).catch(err=>{
          console.log('audio play blocked', err);
          showMusicToast('Clique em 🔊 para ativar o som', 4000);
        });
        showMusicToast();
      });

      db.ref(`rooms/${roomId}/meta/final`).on('value', snap=>{
        const v = snap.val(); if(v) renderFinalOverlay();
      });
    }

    // player shows question
    function showQuestion(cur){
      if(localTimer){ clearInterval(localTimer); localTimer = null; }
      const qText = $('questionText'); const opts = $('optionsArea'); const fb = $('feedbackArea');
      fb.classList.add('hidden'); qText.innerText = cur.q || '—'; opts.innerHTML = '';
      $('qIndex').innerText = `Pergunta ${Number(cur.index)+1}`;
      if($('youName') && state.name) $('youName').innerText = state.name;

      (cur.options||[]).forEach((opt,i)=>{
        const b = create('button'); b.className='option-btn'; b.textContent = opt; b.dataset.index = i;
        b.addEventListener('click', async ()=>{
          Array.from(opts.children).forEach(x=>x.classList.add('disabled'));
          const ansRef = db.ref(`rooms/${state.room}/answers/${cur.index}/${state.uid}`);
          const got = await ansRef.get(); if(got.exists()) return;
          const at = Date.now();
          const isCorrect = Number(i) === Number(cur.correct);
          await ansRef.set({ choice:Number(i), at, name: state.name, isCorrect: !!isCorrect });
          if(isCorrect){ b.classList.add('correct'); playCorrect(); } else { b.classList.add('wrong'); playWrong(); }
          showFeedback(isCorrect);
        });
        opts.appendChild(b);
      });

      const total = Number(cur.time || 20);
      const startAt = Number(cur.startAt) || Date.now();
      const progressBar = $('progressBar');
      function tick(){
        const elapsed = Date.now() - startAt;
        const remS = Math.max(0, Math.ceil((startAt + total*1000 - Date.now())/1000));
        const pct = Math.max(0, Math.min(100, Math.round(((total*1000 - elapsed)/(total*1000))*100)));
        if(progressBar) progressBar.style.width = pct + '%';
        if($('timer')) $('timer').innerText = `Tempo: ${remS}s`;
        if(remS <= 0 && localTimer){ clearInterval(localTimer); localTimer = null; }
      }
      tick(); localTimer = setInterval(tick, 200);
    }

    function playCorrect(){ try{ if(!isMuted){ effectCorrect.currentTime = 0; effectCorrect.volume = localVolume; effectCorrect.play().catch(()=>{}); } }catch(e){} }
    function playWrong(){ try{ if(!isMuted){ effectWrong.currentTime = 0; effectWrong.volume = localVolume; effectWrong.play().catch(()=>{}); } }catch(e){} }
    function showFeedback(ok){ const fb = $('feedbackArea'); fb.classList.remove('hidden','good','bad'); fb.classList.add(ok?'good':'bad'); fb.innerText = ok ? POSITIVE[Math.floor(Math.random()*POSITIVE.length)] : NEGATIVE[Math.floor(Math.random()*NEGATIVE.length)]; try{ navigator.vibrate && navigator.vibrate(ok?[20]:[30,20]); }catch(e){} }

    // scheduling tally
    function scheduleTally(room, index, startAt, totalMs){ const key = `${room}::${index}`; if(scheduled[key]) return; scheduled[key] = true; setTimeout(()=> tallyQuestion(room, index, startAt, totalMs), totalMs + 900); }

    // tally: aggregate answers and update players scores
    async function tallyQuestion(room, index, startAt, totalMs){
      try{
        const markRef = db.ref(`rooms/${room}/tallied/${index}`);
        const mark = await markRef.get(); if(mark.exists()) return;

        const answersSnap = await db.ref(`rooms/${room}/answers/${index}`).get(); const answers = answersSnap.val() || {};
        const playersSnap = await db.ref(`rooms/${room}/players`).get(); const players = playersSnap.val() || {};

        for(const uid of Object.keys(answers)){
          const a = answers[uid]; if(!a) continue;
          const elapsed = Math.max(0, Number(a.at || Date.now()) - Number(startAt));
          const within = elapsed <= Number(totalMs);
          const correct = !!a.isCorrect && within;

          const p = players[uid] || { score:0, correctCount:0, answeredCount:0, avgTime:0 };
          const prevAnswered = Number(p.answeredCount || 0);
          const newAnswered = prevAnswered + 1;
          const prevCorrect = Number(p.correctCount || 0);
          const newCorrect = prevCorrect + (correct ? 1 : 0);
          const prevScore = Number(p.score || 0);
          const newScore = prevScore + (correct ? 10 : 0);
          const prevAvg = Number(p.avgTime || 0); // stored in ms
          const prevTotalTime = prevAvg * prevAnswered; // ms
          const newAvg = Math.round((prevTotalTime + elapsed) / newAnswered); // ms

          await db.ref(`rooms/${room}/players/${uid}`).update({ score: newScore, correctCount: newCorrect, answeredCount: newAnswered, avgTime: newAvg });
        }

        await markRef.set({ talliedAt: firebase.database.ServerValue.TIMESTAMP });
        const freshPlayers = (await db.ref(`rooms/${room}/players`).get()).val() || {};
        renderLeaderboard(freshPlayers);
      } catch(err){ console.error('Erro em tallyQuestion:', err); }
    }

    // render leaderboard with strict tiebreak rules
    function renderLeaderboard(playersObj){
      const players = playersObj || {};
      const list = Object.keys(players).map(uid => {
        const p = players[uid] || {};
        return { uid, name: p.name || 'Jogador', score: Number(p.score || 0), correct: Number(p.correctCount || 0), avgTime: Number(p.avgTime || 0), answered: Number(p.answeredCount || 0) };
      });

      list.sort((A,B) => {
        if(B.score !== A.score) return B.score - A.score;
        if(B.correct !== A.correct) return B.correct - A.correct;
        const aAvg = A.avgTime === 0 ? Infinity : A.avgTime; const bAvg = B.avgTime === 0 ? Infinity : B.avgTime;
        if(aAvg !== bAvg) return aAvg - bAvg;
        if(B.answered !== A.answered) return B.answered - A.answered;
        return A.name.localeCompare(B.name);
      });

      if(list.length === 0){ organizerLeaderboard.innerHTML = '<div class="small">Nenhum jogador ainda</div>'; return; }

      const html = list.map((p,i)=>{
        const medal = i===0?'<div class="medal gold">1</div>':i===1?'<div class="medal silver">2</div>':i===2?'<div class="medal bronze">3</div>':'<div style="width:44px"></div>';
        const avgDisplay = p.avgTime === 0 ? '--' : (p.avgTime/1000).toFixed(1) + 's';
        return `<div class="lead-item ${i<3?'top':''}" data-uid="${p.uid}"><div style="display:flex;gap:12px;align-items:center">${medal}<div style="font-weight:800">${escapeHtml(p.name)}</div></div><div style="text-align:right"><div style="font-weight:800">${p.score} pts</div><div class="small">${p.correct} acertos — ${avgDisplay}</div></div></div>`;
      }).join('');
      organizerLeaderboard.innerHTML = html;
    }

    // final overlay (adjusted): appears to everyone; only Close button that clears room and returns to start
    async function renderFinalOverlay(){
      try{
        if(!state.room) return; if(document.querySelector('.final-overlay')) return;
        const players = (await db.ref(`rooms/${state.room}/players`).get()).val() || {};
        const list = Object.values(players).sort((a,b)=> (Number(b.score||0) - Number(a.score||0)) || (Number(b.correctCount||0) - Number(a.correctCount||0)) || ((Number(a.avgTime||0)===0?Infinity:Number(a.avgTime||0)) - (Number(b.avgTime||0)===0?Infinity:Number(b.avgTime||0))) );

        const overlay = document.createElement('div'); overlay.className='final-overlay';
        overlay.innerHTML = `
          <div class="final-card">
            <h2 style="text-align:center">🏁 Resultado Final — Cenjud Play</h2>
            <div class="final-list">
              ${list.map((p,i)=>`<div style="display:flex;align-items:center;justify-content:space-between;padding:10px;border-radius:8px;margin-top:8px;background:#fff"><div style="display:flex;align-items:center;gap:12px"><div class="final-medal">${i===0?'🥇':i===1?'🥈':i===2?'🥉':(i+1)+'.'}</div><div style="font-weight:800">${escapeHtml(p.name)}</div></div><div style="text-align:right"><div style="font-weight:800">${p.score || 0} pts</div><div class="small">${(p.correctCount||0)} acertos — ${p.avgTime ? (p.avgTime/1000).toFixed(1)+'s' : '--'}</div></div></div>`).join('')}
            </div>
            <div style="text-align:center;margin-top:16px">
              <button id="closeFinal" class="btn-primary">Fechar</button>
            </div>
          </div>
        `;
        document.body.appendChild(overlay);

        overlay.querySelector('#closeFinal').addEventListener('click', async ()=>{
          try{
            await db.ref(`rooms/${state.room}`).remove();
          }catch(e){ console.error('Erro ao limpar sala:', e); }
          location.reload();
        });
      }catch(err){ console.error('Erro renderFinalOverlay', err); }
    }

    // utilities
    function genUid(n){ return n.replace(/\s+/g,'_') + '_' + Math.floor(Math.random()*99999); }
    function escapeHtml(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    // parse sheet rows into internal question format
    function parseQuestionsFromSheet(rows){
      const normalized = rows.map(r=>{ const nr={}; for(const k of Object.keys(r)){ const nk = k.toString().trim().toLowerCase(); nr[nk]=r[k]; } return nr; });
      const res=[];
      for(const r of normalized){
        const q = r['pergunta'] || r['pergunta?'] || r['questão'] || r['questao'] || r['q'] || r['question']; if(!q) continue;
        const optA = r['opção a'] || r['opcao a'] || r['a'] || r['opcao_a'] || r['opcaoa'];
        const optB = r['opção b'] || r['opcao b'] || r['b'] || r['opcao_b'];
        const optC = r['opção c'] || r['opcao c'] || r['c'] || r['opcao_c'];
        const optD = r['opção d'] || r['opcao d'] || r['d'] || r['opcao_d'];
        const opts=[]; if(optA) opts.push(String(optA)); if(optB) opts.push(String(optB)); if(optC) opts.push(String(optC)); if(optD) opts.push(String(optD));
        if(opts.length===0){ for(let i=1;i<=6;i++){ const candidate = r['opcao '+i] || r['option '+i] || r['option'+i] || r['opcao'+i]; if(candidate) opts.push(String(candidate)); } }
        let ans = r['respostacorreta'] || r['resposta'] || r['resposta correta'] || r['resposta_correta']; let answerIndex = 0;
        if(ans !== undefined && ans !== null && ans !== ''){ const s = String(ans).trim(); if(/^[0-9]+$/.test(s)) answerIndex = Number(s); else if(/^[a-dA-D]$/.test(s)){ answerIndex = 'ABCD'.indexOf(s.toUpperCase()); } else { const idx = opts.findIndex(o => String(o).trim().toLowerCase() === s.toLowerCase()); if(idx >= 0) answerIndex = idx; } }
        const time = Number(r['tempo'] || r['time'] || 20) || 20;
        res.push({ q: String(q), options: opts.length ? opts : ['A','B'], answer: answerIndex, time });
      }
      return res;
    }

    // small helper: show a toast message for music
    function showMusicToast(msg = '🎵 Trilha ativada', time = 1800){
      musicToast.innerText = msg;
      musicToast.style.display = 'block';
      setTimeout(()=> { musicToast.style.display = 'none'; }, time);
    }

    window._drs = { OFFICIAL_QUESTIONS, scheduleTally, tallyQuestion, parseQuestionsFromSheet, TRACKS, EFFECTS, tryUnlockAudio };

    console.log('Cenjud Play pronto — interface carregada');
  });
  </script>

<!-- Player de áudio visível no rodapé (GitHub Pages pronto) -->
<div style="text-align:center;margin-top:20px;padding:10px 0;background:#f8fafc;border-top:1px solid #e5ecfa;">
  <audio id="bgMusic" controls style="width:320px;"></audio>
  <p style="font-size:0.9em;color:#555;margin:6px 0 0;">
    Clique em ▶️ play uma vez para liberar o som. Depois, selecione a trilha.
  </p>
</div>

<script>
const TRACKS = {
  energia: "https://dirproccenjud.github.io/play/energy-pop-152391.mp3",
  blues: "https://dirproccenjud.github.io/play/majestic-blues-351409.mp3",
  funk: "https://dirproccenjud.github.io/play/fun-funk-music-349237.mp3",
  estilo: "https://dirproccenjud.github.io/play/fashion-upbeat-dance-designer-416395.mp3",
  corporativo: "https://dirproccenjud.github.io/play/ambient-corporate-inspiring-money-403965.mp3",
  pop: "https://dirproccenjud.github.io/play/upbeat-pop-fun-happy-commercial-music-401980.mp3",
  horizonte: "https://dirproccenjud.github.io/play/beyond-the-horizon-cinematic-background-music-for-video-short-2-413333.mp3"
};

window.addEventListener('load', () => {
  const player = document.getElementById('bgMusic');
  const select = document.getElementById('musicSelect');
  if (!select) return;
  select.addEventListener('change', e => {
    const key = e.target.value;
    if (!key) { player.pause(); return; }
    const url = TRACKS[key];
    if (!url) return;
    player.src = url;
    player.play().catch(err => console.warn('Playback bloqueado até interação manual:', err));
  });
});
</script>

</body>
</html>
